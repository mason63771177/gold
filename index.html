<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>裂金7日 H5 页面</title>
  
  <!-- Google Tag Manager -->
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-K7WCTWLM');</script>
  <!-- End Google Tag Manager -->
  
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-QQ6GQ79K7G"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-QQ6GQ79K7G');
  </script>
  
  <link rel="stylesheet" href="themes.css">
  <link rel="stylesheet" href="css/global-background.css">
  <script src="theme-switcher.js"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100vh;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
        "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      font-size: 16px;
      overflow: hidden;
    }

    /* 应用容器 100vh 三段式布局 */
    .app {
      height: 100vh;
      display: flex;
      flex-direction: column;
      position: relative;
      z-index: 1;
    }

    /* 顶部区域 - 固定高度 */
    .header {
      flex: 0 0 90px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
      padding-top: 8px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-color);
      z-index: 100;
    }
    
    .header-main {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 4px;
    }
    
    .status-info {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .logo {
      font-size: 32px;
      font-weight: 700;
      letter-spacing: 1px;
      background: var(--btn-gradient);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      filter: var(--logo-filter);
    }

    /* 新的 logo 图片样式 - 放大尺寸 */
    .logo-img {
      width: 65px;
      height: 65px;
      object-fit: contain;
      filter: var(--logo-filter);
    }
    .state-label {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-secondary);
      text-shadow: 0 0 6px var(--accent-color);
    }
    .subtitle {
      font-size: 13px;
      color: var(--text-secondary);
      opacity: 0.8;
    }
    /* 开发测试按钮，可隐藏于生产环境 */
    .test-btn {
      position: absolute;
      top: 8px;
      right: 12px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      color: var(--accent-color);
      font-size: 12px;
      padding: 3px 6px;
    }
    
    .reset-btn {
      position: absolute;
      top: 8px;
      right: 90px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      color: #ff6464;
      font-size: 12px;
      padding: 3px 6px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .reset-btn:hover {
      background: linear-gradient(135deg, #ff6464, #ff4444);
      color: var(--text-primary);
      transform: translateY(-1px);
    }
    
    .theme-demo-btn {
      position: absolute;
      top: 8px;
      left: 12px;
      background: var(--btn-gradient);
      border: none;
      border-radius: 6px;
      color: var(--text-primary);
      font-size: 12px;
      padding: 3px 6px;
      cursor: pointer;
      box-shadow: var(--btn-shadow);
      transition: all 0.3s ease;
    }
    
    .theme-demo-btn:hover {
       transform: translateY(-1px);
       filter: brightness(1.1);
     }
     
     .test-btn {
       cursor: pointer;
       transition: all 0.3s ease;
    }
    .test-btn:hover {
      background: var(--btn-gradient);
      color: var(--text-primary);
    }

    /* 中部内容卡片区域 - 可滚动 */
    .content {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden; /* 禁止水平滚动 */
      padding: 16px;
      padding-bottom: 100px; /* 为底部固定按钮留出空间 */
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .card {
      width: 100%;
      max-width: 480px;
      background: var(--bg-card);
      border-radius: 24px;
      padding: 24px;
      border: 1px solid var(--border-color);
      box-shadow: var(--btn-shadow);
      backdrop-filter: blur(16px);
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    .section {
      margin-bottom: 16px;
      position: relative;
    }
    .section:last-child {
      margin-bottom: 0;
    }
    /* 光效分割线 */
    .section:not(:last-child)::after {
      content: "";
      position: absolute;
      bottom: -8px;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, var(--accent-color), transparent);
      opacity: 0.4;
    }
    .section-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 6px;
      color: var(--text-secondary);
    }
    .section-content {
      font-size: 14px;
      line-height: 1.4;
      color: var(--text-primary);
      opacity: 0.9;
    }
    /* 任务列表样式 */
    .task-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .task-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 0;
    }
    .task-item:not(:last-child) {
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }
    .task-title {
      flex: 1;
      font-size: 14px;
      color: #e0e5fb;
    }
    .task-status {
      font-size: 12px;
      padding: 2px 6px;
      border-radius: 12px;
      background: linear-gradient(45deg, #00eaff, #0088ff);
      box-shadow: 0 0 6px rgba(0, 136, 255, 0.6);
      color: #031e2e;
    }
    .task-status.done {
      background: linear-gradient(45deg, #9be15d, #00e3ae);
      box-shadow: 0 0 6px rgba(0, 227, 174, 0.6);
    }
    /* 再次激活突出样式 */
    .reactivate-highlight {
      background: linear-gradient(135deg, rgba(255, 107, 107, 0.15), rgba(255, 193, 7, 0.15));
      border: 2px solid rgba(255, 107, 107, 0.3);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
      position: relative;
      overflow: hidden;
    }
    .reactivate-highlight::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
      animation: shimmer 2s infinite;
    }
    @keyframes shimmer {
      0% { left: -100%; }
      100% { left: 100%; }
    }
    .reactivate-highlight .section-title {
      color: #ff6b6b;
      font-size: 18px;
      font-weight: 700;
      text-shadow: 0 0 10px rgba(255, 107, 107, 0.5);
    }
    .reactivate-btn {
      background: linear-gradient(45deg, #ff6b6b, #ffc107);
      border: none;
      border-radius: 25px;
      padding: 12px 24px;
      font-size: 16px;
      font-weight: 600;
      color: white;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
      transition: all 0.3s ease;
      width: 100%;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    }
    .reactivate-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255, 107, 107, 0.6);
    }
    .reactivate-btn:active {
       transform: translateY(0);
     }

    /* 底部按钮区域 - 固定在屏幕底部 */
    .bottom {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 14px 16px calc(24px + env(safe-area-inset-bottom, 0px));
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      /* 半透明背景与模糊，仿原生底部栏 */
      background: rgba(255, 255, 255, 0.04);
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(255, 255, 255, 0.06);
      margin: 0 12px 12px;
      border-radius: 20px 20px 0 0;
      z-index: 100;
    }
    .bottom button {
      flex: 1;
      min-width: 0;
      border: none;
      border-radius: 16px;
      padding: 12px 8px;
      font-size: 13px;
      font-weight: 800;
      color: var(--text);
      cursor: pointer;
      transition: transform 0.08s ease, filter 0.2s ease, box-shadow 0.2s ease;
      /* 避免移动端按钮文字换行 */
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      background-image: linear-gradient(180deg, var(--brand), var(--brand-2));
      box-shadow: 0 8px 24px rgba(47, 128, 237, 0.45), inset 0 1px 0 rgba(255, 255, 255, 0.25);
    }
    /* 当按钮超过6个时，调整布局 */
    .bottom.many-buttons {
      justify-content: center;
    }
    .bottom.many-buttons button {
      flex: 0 1 calc(33.333% - 6px);
      margin: 2px;
      padding: 10px 6px;
      font-size: 12px;
    }
    /* 按钮颜色渐变 */
    .bottom button.red,
    .bottom button.orange,
    .bottom button.green,
    .bottom button.purple,
    .bottom button.blue {
      background: var(--btn-gradient);
      box-shadow: var(--btn-shadow), var(--btn-glow);
    }
    .bottom button:disabled {
      opacity: 0.4;
      cursor: default;
      filter: grayscale(0.6);
    }
    .bottom button:not(:disabled):hover {
      transform: translateY(-3px);
      filter: brightness(1.2);
    }
    .bottom button:not(:disabled):active {
      transform: translateY(0);
      filter: brightness(0.95);
    }
    /* 邀请按钮突出显示，增加光晕 */
    .bottom button[data-key="invite"],
    .bottom button[data-key="inviteNew"] {
      box-shadow: 0 12px 32px rgba(86, 204, 242, 0.55), inset 0 1px 0 rgba(255, 255, 255, 0.3);
    }
    /* 统一样式的对话框提示 */
    .dialog {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .dialog .dialog-box {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 20px 24px;
      max-width: 90%;
      color: var(--text-primary);
      box-shadow: var(--btn-shadow);
      border: 1px solid var(--border-color);
    }
    .dialog .dialog-box h3 {
    }

    /* 模态框基础样式 */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal-content {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 24px;
      position: relative;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      border: 1px solid var(--border-color);
    }
    .modal-close {
      position: absolute;
      top: 12px;
      right: 12px;
      background: none;
      border: none;
      font-size: 20px;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 4px;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }
    .modal-close:hover {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-primary);
    }

    /* 设置面板样式 */
    .settings-panel {
      padding: 0;
    }
    .settings-section {
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    .settings-section:last-child {
      border-bottom: none;
      margin-bottom: 0;
    }
    .settings-section h3 {
      margin: 0 0 12px 0;
      font-size: 16px;
      color: var(--text-primary);
      font-weight: 600;
    }
    .settings-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      color: var(--text-secondary);
    }
    .settings-btn {
      background: linear-gradient(135deg, var(--brand), var(--brand-2));
      color: white;
      border: none;
      border-radius: 8px;
      padding: 8px 16px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 2px 8px rgba(47, 128, 237, 0.3);
    }
    .settings-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(47, 128, 237, 0.4);
    }
    .settings-btn:active {
      transform: translateY(0);
    }
    .settings-select {
      background: var(--bg-card);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 6px 12px;
      font-size: 14px;
      cursor: pointer;
    }
    .settings-select:focus {
      outline: none;
      border-color: var(--brand);
      box-shadow: 0 0 0 2px rgba(47, 128, 237, 0.2);
    }
    .dialog .dialog-box h3 {
      margin: 0 0 12px;
      font-size: 18px;
      color: var(--text-secondary);
    }
    .dialog .dialog-box p {
      margin: 0 0 20px;
      font-size: 14px;
      line-height: 1.4;
    }
    .dialog .dialog-box button {
      padding: 8px 16px;
      border: none;
      border-radius: 14px;
      background: var(--btn-gradient);
      color: var(--text-primary);
      font-weight: 600;
      cursor: pointer;
      box-shadow: var(--btn-shadow);
    }
    /* 邀请区高亮样式 */
    .invite-highlight {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      padding: 12px;
      margin-top: 12px;
      box-shadow: var(--btn-glow);
    }
    .invite-highlight .section-title {
      color: var(--accent-color);
    }
    
    .invite-link-container {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .invite-link-container input {
      flex: 1;
      min-width: 0;
    }
    
    .invite-link-container button:hover {
      background: linear-gradient(135deg, #45a049, #3d8b40) !important;
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
  </style>
</head>
<body>
  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-K7WCTWLM"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->
  
  <div id="app" class="app">
    <div class="header">
      <div class="header-main">
        <!-- 放大的logo -->
        <img src="logo_gold7.png" alt="Logo" class="logo-img" />
        <div class="status-info">
          <div id="stateLabel" class="state-label">状态1</div>
          <div id="subtitle" class="subtitle">欢迎加入裂金7日</div>
        </div>
      </div>
      <button class="theme-demo-btn" onclick="window.location.href='theme-demo.html'">主题演示</button>
      <button class="test-btn" onclick="cycleState()">切换状态</button>
      <button class="reset-btn" onclick="resetTestData()">重置数据</button>
      <button class="settings-btn" onclick="console.log('设置按钮被点击'); openSettings();" style="background: linear-gradient(135deg, #4CAF50, #45a049); color: white; border: none; border-radius: 8px; padding: 8px 12px; font-size: 12px; cursor: pointer; margin-left: 8px; position: relative; z-index: 999;">⚙️ 设置</button>
    </div>
    <div class="content">
      <div id="card" class="card">
        <!-- 动态内容将在这里注入 -->
      </div>
    </div>
    <div id="bottomButtons" class="bottom">
      <!-- 底部按钮动态生成 -->
    </div>
  </div>
  <!-- 模态弹窗 -->
  <div id="modal" class="modal" style="display:none;">
    <div class="modal-content">
      <button id="modalClose" class="modal-close">✕</button>
      <div id="modalBody"></div>
    </div>
  </div>
  <div id="dialog" class="dialog" style="display:none;">
    <div class="dialog-box">
      <h3 id="dialogTitle">提示</h3>
      <p id="dialogMsg">内容</p>
      <button onclick="closeDialog()">确定</button>
    </div>
  </div>

  <!-- 设置面板 -->
  <div id="settingsModal" class="modal" style="display:none;">
    <div class="modal-content" style="max-width: 400px; width: 90%;">
      <button class="modal-close" onclick="closeSettings()">✕</button>
      <div class="settings-panel">
        <h2 style="margin: 0 0 20px 0; color: var(--text-primary); text-align: center;">⚙️ 设置</h2>
        
        <!-- 个人信息 -->
        <div class="settings-section">
          <h3>👤 个人信息</h3>
          <div class="settings-item">
            <span>邮箱：</span>
            <span id="userEmailDisplay">未登录</span>
          </div>
          <div class="settings-item">
            <span>邀请码：</span>
            <span id="userInviteCodeDisplay">-</span>
          </div>
        </div>

        <!-- 主题风格 -->
        <div class="settings-section">
          <h3>🎨 主题风格</h3>
          <div class="settings-item">
            <button class="settings-btn" onclick="window.location.href='theme-demo.html'">选择主题风格</button>
          </div>
        </div>

        <!-- 语言选择 -->
        <div class="settings-section">
          <h3>🌐 语言设置</h3>
          <div class="settings-item">
            <select id="languageSelect" class="settings-select">
              <option value="zh-CN">简体中文</option>
              <option value="zh-TW">繁體中文</option>
              <option value="en-US">English</option>
              <option value="ja-JP">日本語</option>
              <option value="ko-KR">한국어</option>
            </select>
          </div>
        </div>

        <!-- 其他设置 -->
        <div class="settings-section">
          <h3>🔧 其他设置</h3>
          <div class="settings-item">
            <button class="settings-btn" onclick="resetTestData()">重置测试数据</button>
          </div>
        </div>

        <!-- 退出登录 -->
        <div class="settings-section">
          <div class="settings-item">
            <button class="settings-btn logout-btn" onclick="logout()" style="background: linear-gradient(135deg, #ff6b6b, #ee5a52); color: white;">🚪 退出登录</button>
          </div>
        </div>

        <!-- 返回按钮 -->
        <div class="settings-section" style="margin-top: 20px; border-top: 1px solid var(--border-color); padding-top: 20px;">
          <div class="settings-item">
            <button class="settings-btn back-btn" onclick="closeSettings()" style="background: linear-gradient(135deg, #6c757d, #5a6268); color: white; width: 100%; padding: 12px; font-size: 16px;">← 返回</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // 设置面板功能 - 提前定义确保onclick可以找到
    function openSettings() {
      console.log('openSettings函数被调用');
      const settingsModal = document.getElementById('settingsModal');
      console.log('settingsModal元素:', settingsModal);
      
      if (!settingsModal) {
        console.error('找不到settingsModal元素');
        alert('设置面板元素未找到，请刷新页面重试');
        return;
      }
      
      settingsModal.style.display = 'flex';
      console.log('设置面板已显示');
      
      // 更新个人信息显示
      updateSettingsInfo();
    }

    function closeSettings() {
      const settingsModal = document.getElementById('settingsModal');
      settingsModal.style.display = 'none';
    }

    function updateSettingsInfo() {
      const userEmail = localStorage.getItem('userEmail') || '未登录';
      const userInviteCode = localStorage.getItem('userInviteCode') || '-';
      const currentLanguage = localStorage.getItem('language') || 'zh-CN';
      
      document.getElementById('userEmailDisplay').textContent = userEmail;
      document.getElementById('userInviteCodeDisplay').textContent = userInviteCode;
      document.getElementById('languageSelect').value = currentLanguage;
    }

    /* 状态数据与逻辑定义 */
    const STATES = {
      1: {
        name: '状态1',
        subtitle: '新手未入金',
        card: function() {
          return `
            <div class="section">
              <div class="section-title">激活账号</div>
              <div class="section-content">立即入金100 USDT，开启168小时挑战。</div>
            </div>
            <div class="section">
              <div class="section-title">查看收益榜单</div>
              <div class="section-content">查看前10名收益排行榜，了解潜在收益。</div>
            </div>
          `;
        },
        buttons: [
          { text: '激活账号', color: 'green', action: () => activateAccount() },
          { text: '排行榜', color: 'purple', action: () => showRanking() }
        ]
      },
      2: {
        name: '状态2',
        subtitle: '168小时倒计时中',
        card: function() {
          // 当前新手任务：只显示尚未完成的第一个任务
          const currentTask = newTasks.find(t => !t.done);
          let taskSection;
          if (currentTask) {
            taskSection = `
            <div class="section">
              <div class="section-title">当前任务</div>
              <div class="section-content">${currentTask.title}</div>
            </div>
            `;
          } else {
            taskSection = `
            <div class="section">
              <div class="section-title">当前任务</div>
              <div class="section-content">所有新手任务已完成</div>
            </div>
            `;
          }
          const completedTasks = newTasks.filter(t => t.done).length;
          
          // 可接的任务区域：显示所有未完成的新手任务
          const availableTasks = newTasks.filter(t => !t.done);
          let availableTasksSection = '';
          if (availableTasks.length > 0) {
            availableTasksSection = `
            <div class="section" style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; padding: 8px; margin-bottom: 8px; cursor: pointer;" onclick="window.location.href='tasks.html'">
              <div class="section-title" style="font-size: 14px; font-weight: bold; color: var(--accent-color); margin-bottom: 6px;">📋 可接的任务</div>
              <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">点击查看详细任务列表</div>
              <div style="display: flex; flex-direction: column; gap: 4px;">
                ${availableTasks.map(task => `
                  <div style="display: flex; justify-content: space-between; align-items: center; padding: 4px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                    <span style="font-size: 12px; color: var(--text);">${task.title}</span>
                    <span style="font-size: 10px; padding: 2px 6px; background: linear-gradient(45deg, #00eaff, #0088ff); color: #031e2e; border-radius: 8px;">待完成</span>
                  </div>
                `).join('')}
              </div>
            </div>
            `;
          }
          
          // 答题任务区域：完成至少一个新手任务后出现，且未完成全部20题
          const firstDone = newTasks[0] && newTasks[0].done;
          const quizCorrect = parseInt(localStorage.getItem('quizCorrect')) || 0;
          let quizSection = '';
          if (firstDone && quizCorrect < 20) {
            quizSection = `
            <div class="section" style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; padding: 8px; margin-bottom: 8px; box-shadow: var(--btn-glow); cursor: pointer;" onclick="window.location.href='quiz.html'">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <div style="font-size: 14px; font-weight: bold; color: var(--accent-color); margin-bottom: 2px;">📝 答题任务</div>
                  <div style="font-size: 12px; color: var(--text-secondary);">降低提现手续费</div>
                </div>
                <div style="text-align: right;">
                  <div style="font-size: 12px; color: var(--text-secondary);">进度</div>
                  <div style="font-weight: bold; color: var(--accent-color);">${quizCorrect}/20</div>
                </div>
              </div>
            </div>
            `;
          }
          
          // 大神任务区域：完成所有新手任务且完成答题任务后显示
          const allNewTasksCompleted = newTasks.every(task => task.done);
          const quizCompleted = quizCorrect >= 20;
          let masterTasksSection = '';
          if (allNewTasksCompleted && quizCompleted) {
            // 获取大神任务完成状态
            const godTasksCompleted = parseInt(localStorage.getItem('godTasksCompleted')) || 0;
            const currentMasterTask = godTasks.find(task => !task.done);
            
            masterTasksSection = `
            <div class="section" style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; padding: 8px; margin-bottom: 8px; box-shadow: var(--btn-glow); cursor: pointer;" onclick="window.location.href='tasks.html?tab=master'">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <div style="font-size: 14px; font-weight: bold; color: var(--accent-color); margin-bottom: 2px;">🏆 大神任务</div>
                  <div style="font-size: 12px; color: var(--text-secondary);">${currentMasterTask ? currentMasterTask.title : '所有大神任务已完成'}</div>
                </div>
                <div style="text-align: right;">
                  <div style="font-size: 12px; color: var(--text-secondary);">进度</div>
                  <div style="font-weight: bold; color: var(--accent-color);">${godTasksCompleted}/6</div>
                </div>
              </div>
            </div>
            `;
          }
          
          return `
            <div class="section" style="display: flex; gap: 12px; margin-bottom: 8px;">
              <div style="flex: 1; background: var(--bg-secondary); border-radius: 12px; padding: 16px; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 80px;">
                <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;">⏰ 倒计时</div>
                <div style="font-weight: bold; color: var(--accent-color); font-size: 16px; line-height: 1;"><span id="countdown">--:--:--</span></div>
              </div>
              <div style="flex: 1.2; background: var(--bg-secondary); border-radius: 12px; padding: 12px;">
                <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 6px; text-align: center;">🏆 战绩卡</div>
                <div style="font-size: 11px; line-height: 1.3; color: var(--text-primary);">
                  <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                    <span>新手任务:</span>
                    <span style="color: var(--accent-color); font-weight: bold;"><span id="taskProgress">${completedTasks}</span>/3</span>
                  </div>
                  <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                     <span>答题进度:</span>
                     <span style="color: var(--accent-color); font-weight: bold;">${quizCorrect}/20</span>
                   </div>
                  <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                    <span>团队人数:</span>
                    <span style="color: var(--accent-color); font-weight: bold;"><span id="teamCount">${teamMembers}</span>人</span>
                  </div>
                  <div style="display: flex; justify-content: space-between;">
                    <span>总收益:</span>
                    <span style="color: var(--success-color); font-weight: bold;"><span id="totalEarnings">${totalEarnings.toFixed(2)}</span> USDT</span>
                  </div>
                </div>
              </div>
            </div>
            ${availableTasksSection}
            ${quizSection}
            ${masterTasksSection}
            <div class="section invite-highlight">
              <div class="section-title">邀请链接</div>
              <div class="section-content">
                <!-- 倒计时和进度条 -->
                <div style="margin-bottom: 12px;">
                  <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                    <span style="font-size: 12px; color: var(--text-secondary);">有效期剩余</span>
                    <span id="inviteLeft" style="font-weight: bold; color: var(--accent-color);">168h</span>
                  </div>
                  <div style="width: 100%; height: 6px; background: var(--bg-secondary); border-radius: 3px; overflow: hidden;">
                    <div id="inviteProgress" style="height: 100%; background: linear-gradient(90deg, #4CAF50, #45a049, #FFD700); border-radius: 3px; width: 100%; transition: width 0.3s ease;"></div>
                  </div>
                </div>
                
                <!-- 专属邀请码区域 -->
                <div style="margin-bottom: 12px; padding: 8px; background: var(--bg-secondary); border-radius: 8px;">
                  <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 6px; text-align: center;">🎯 我的专属邀请码</div>
                  <div style="display: flex; align-items: center; gap: 8px;">
                    <div style="flex: 1; font-weight: bold; color: var(--accent-color); font-size: 16px; text-align: center; padding: 6px; background: var(--bg-primary); border-radius: 6px; border: 2px dashed var(--accent-color);" id="myInviteCode">ABC123</div>
                    <button onclick="copyInviteCode()" style="padding: 6px 12px; background: linear-gradient(135deg, #FF6B6B, #FF5252); color: white; border: none; border-radius: 6px; font-size: 11px; cursor: pointer; white-space: nowrap;">复制码</button>
                  </div>
                </div>
                
                <!-- 邀请链接区域 -->
                <div style="padding: 8px; background: var(--bg-secondary); border-radius: 8px;">
                  <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 6px; text-align: center;">🔗 邀请链接</div>
                  <div class="invite-link-container" style="display: flex; gap: 8px;">
                    <input type="text" id="inviteLink" value="https://gold7.com/invite?code=ABC123" readonly style="flex: 1; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-primary); font-size: 11px; color: var(--text-primary);">
                    <button onclick="copyInviteLink()" style="padding: 8px 12px; background: linear-gradient(135deg, #4CAF50, #45a049); color: white; border: none; border-radius: 6px; font-size: 11px; cursor: pointer; white-space: nowrap;">复制链接</button>
                  </div>
                </div>
              </div>
            </div>
          `;
        },
        buttons: [
          { text: '任务', color: 'green', key: 'task', action: () => openTasks() },
          { text: '红包', color: 'red', key: 'red', action: () => grabRedPacket() },
          { text: '团队', color: 'orange', key: 'team', action: () => showTeam() },
          { text: '钱包', color: 'purple', key: 'wallet', action: () => showWallet() },
          { text: '排行', color: 'green', key: 'rank', action: () => showRanking() }
        ]
      },
      3: {
        name: '状态3',
        subtitle: '倒计时结束未复购',
        card: function() {
          const completedTasks = newTasks.filter(t => t.done).length;
          return `
            <div class="section reactivate-highlight">
              <div class="section-title">🔥 再次激活</div>
              <div class="section-content">
                <p style="margin-bottom: 12px;">重新开启168小时挑战，继续赚取收益！</p>
                <button class="reactivate-btn" onclick="repurchase()">立即激活 100 USDT</button>
              </div>
            </div>
            <div class="section">
              <div class="section-title">战绩卡</div>
              <div class="section-content">本期收益：<strong>${totalEarnings.toFixed(2)} USDT</strong><br/>新手任务：${completedTasks}/3 完成<br/>团队人数：${teamMembers}人</div>
            </div>
            <div class="section">
              <div class="section-title">我的团队</div>
              <div class="section-content">查看七层团队结构和人数。</div>
            </div>
          `;
        },
        buttons: [
          { text: '团队', color: 'orange', action: () => showTeam() },
          { text: '钱包', color: 'purple', action: () => showWallet() },
          { text: '排行', color: 'green', action: () => showRanking() }
        ]
      },
      4: {
        name: '状态4',
        subtitle: '复购状态',
        card: function() {
          // 判断是否解锁大神任务：所有新手任务已完成
          const allNewDone = newTasks.every(t => t.done);
          let godSection;
          if (allNewDone) {
            // 只显示当前未完成的大神任务，未触发的不显示
            const currentGod = godTasks.find(t => !t.done);
            if (currentGod) {
              godSection = `<div class="section"><div class="section-title">大神任务</div><div class="section-content">${currentGod.title}</div></div>`;
            } else {
              godSection = `<div class="section"><div class="section-title">大神任务</div><div class="section-content">所有大神任务已完成</div></div>`;
            }
          } else {
            godSection = `<div class="section"><div class="section-title">大神任务</div><div class="section-content">完成新手任务后解锁大神任务</div></div>`;
          }
          
          // 答题任务区域：完成至少一个新手任务后出现，且未完成全部20题
          const firstDone = newTasks[0] && newTasks[0].done;
          const quizCorrect = parseInt(localStorage.getItem('quizCorrect')) || 0;
          let quizSection = '';
          if (firstDone && quizCorrect < 20) {
            quizSection = `
            <div class="section" style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; padding: 8px; margin-bottom: 8px; box-shadow: var(--btn-glow); cursor: pointer;" onclick="window.location.href='quiz.html'">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <div style="font-size: 14px; font-weight: bold; color: var(--accent-color); margin-bottom: 2px;">📝 答题任务</div>
                  <div style="font-size: 12px; color: var(--text-secondary);">降低提现手续费</div>
                </div>
                <div style="text-align: right;">
                  <div style="font-size: 12px; color: var(--text-secondary);">进度</div>
                  <div style="font-weight: bold; color: var(--accent-color);">${quizCorrect}/20</div>
                </div>
              </div>
            </div>
            `;
          }
          // 邀请链接高亮区块，与状态2一致，强调邀请
          const inviteSection = `
            <div class="section invite-highlight">
              <div class="section-title">邀请链接</div>
              <div class="section-content">
                <!-- 倒计时和进度条 -->
                <div style="margin-bottom: 12px;">
                  <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                    <span style="font-size: 12px; color: var(--text-secondary);">有效期剩余</span>
                    <span id="inviteLeft" style="font-weight: bold; color: var(--accent-color);">168h</span>
                  </div>
                  <div style="width: 100%; height: 6px; background: var(--bg-secondary); border-radius: 3px; overflow: hidden;">
                    <div id="inviteProgress" style="height: 100%; background: linear-gradient(90deg, #4CAF50, #45a049, #FFD700); border-radius: 3px; width: 100%; transition: width 0.3s ease;"></div>
                  </div>
                </div>
                
                <!-- 专属邀请码区域 -->
                <div style="margin-bottom: 12px; padding: 8px; background: var(--bg-secondary); border-radius: 8px;">
                  <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 6px; text-align: center;">🎯 我的专属邀请码</div>
                  <div style="display: flex; align-items: center; gap: 8px;">
                    <div style="flex: 1; font-weight: bold; color: var(--accent-color); font-size: 16px; text-align: center; padding: 6px; background: var(--bg-primary); border-radius: 6px; border: 2px dashed var(--accent-color);" id="myInviteCode">ABC123</div>
                    <button onclick="copyInviteCode()" style="padding: 6px 12px; background: linear-gradient(135deg, #FF6B6B, #FF5252); color: white; border: none; border-radius: 6px; font-size: 11px; cursor: pointer; white-space: nowrap;">复制码</button>
                  </div>
                </div>
                
                <!-- 邀请链接区域 -->
                <div style="padding: 8px; background: var(--bg-secondary); border-radius: 8px;">
                  <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 6px; text-align: center;">🔗 邀请链接</div>
                  <div class="invite-link-container" style="display: flex; gap: 8px;">
                    <input type="text" id="inviteLink" value="https://gold7.com/invite?code=ABC123" readonly style="flex: 1; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-primary); font-size: 11px; color: var(--text-primary);">
                    <button onclick="copyInviteLink()" style="padding: 8px 12px; background: linear-gradient(135deg, #4CAF50, #45a049); color: white; border: none; border-radius: 6px; font-size: 11px; cursor: pointer; white-space: nowrap;">复制链接</button>
                  </div>
                </div>
                </div>
              </div>
            </div>
          `;
          return `
            <div class="section" style="display: flex; gap: 12px; margin-bottom: 8px;">
              <div style="flex: 1; background: var(--bg-secondary); border-radius: 12px; padding: 8px; text-align: center;">
                <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">倒计时</div>
                <div style="font-weight: bold; color: var(--accent-color);"><span id="countdown">--:--:--</span></div>
              </div>
              <div style="flex: 1; background: var(--bg-secondary); border-radius: 12px; padding: 8px; text-align: center;">
                <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">大神任务</div>
                <div style="font-weight: bold; font-size: 12px;">${allNewDone ? (godTasks.find(t => !t.done) ? '进行中' : '已完成') : '未解锁'}</div>
              </div>
              <div style="flex: 1; background: var(--bg-secondary); border-radius: 12px; padding: 8px; text-align: center;">
                <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">战绩卡</div>
                <div style="font-weight: bold; font-size: 11px; line-height: 1.3;">团队：<span id="teamCount">${teamMembers}</span>人 | 收益：<span id="totalEarnings">${totalEarnings.toFixed(2)}</span>U</div>
              </div>
            </div>
            ${quizSection}
            ${inviteSection}
            <div class="section" style="margin-top: 8px; padding: 10px;">
              <div class="section-title" style="margin-bottom: 6px;">我的团队</div>
              <div class="section-content" style="font-size: 13px;">查看七层团队结构和人数。</div>
            </div>
          `;
        },
        buttons: [
          { text: '团队', color: 'orange', key: 'team', action: () => showTeam() },
          { text: '钱包', color: 'purple', key: 'wallet', action: () => showWallet() },
          { text: '排行', color: 'blue', key: 'rank', action: () => showRanking() },
          { text: '红包', color: 'red', key: 'red', action: () => grabRedPacket() }
        ]
      }
    };

    /* 任务数据 */
    const newTasks = [
      { id: 1, title: '直接推荐1人', desc: '邀请1位好友注册并激活账号', done: false, reward: 10 },
      { id: 2, title: '帮助下级推荐1人', desc: '指导你的下级成功邀请1位新用户', done: false, reward: 10 },
      { id: 3, title: '教下级如何教他的下级推荐1人', desc: '培训下级的推广技巧，帮助三级推广', done: false, reward: 10 }
    ];
    
    // 答题任务数据
    const quizTasks = [
      { id: 'quiz1', title: '基础知识答题', desc: '完成20道基础题目，正确率达到80%', done: false, reward: 20, feeReduction: 0.02 }
    ];
    
    const godTasks = [
      { id: 1, title: '大神任务一：直推2人 × 2层 = 6人', desc: '建立2层团队结构，每层2人', done: false, reward: 50 },
      { id: 2, title: '大神任务二：直推3人 × 3层 = 39人', desc: '建立3层团队结构，每层3人', done: false, reward: 250 },
      { id: 3, title: '大神任务三：直推4人 × 4层 = 340人', desc: '建立4层团队结构，每层4人', done: false, reward: 1250 },
      { id: 4, title: '大神任务四：直推5人 × 5层 = 3905人', desc: '建立5层团队结构，每层5人', done: false, reward: 6250 },
      { id: 5, title: '大神任务五：直推6人 × 6层 = 55986人', desc: '建立6层团队结构，每层6人', done: false, reward: 31250 },
      { id: 6, title: '大神任务六：直推7人 × 7层 = 960799人', desc: '建立7层团队结构，每层7人', done: false, reward: 156250 }
    ];

    /* 全局状态变量 */
    let currentState = 1;
    let countdownStart = null; // 开启倒计时的时间戳
    let inviteStart = null;    // 邀请链接生效时间戳
    let countdownTimer = null;

    // 模拟用户钱包余额，用于红包和提现功能
    let walletBalance = 0;

    // 交易记录列表
    let transactions = [];

    // 提现手续费比例，默认为 5%（0.05），可通过答题任务降低，最低 1%（0.01）
    let withdrawFeeRate = 0.05;

    // 新增状态管理变量
    let userLevel = 0; // 用户等级 0:未激活 1:已激活
    let completedNewbieTasks = 0; // 已完成新手任务数量
    let quizCompleted = false; // 答题任务是否完成
    let godTasksUnlocked = false; // 大神任务是否解锁
    let teamMembers = 0; // 团队成员数量
    let totalEarnings = 0; // 总收益

    /**
     * 从 localStorage 初始化状态，包括余额、任务完成状态和交易记录。
     */
    function loadState() {
      const savedState = localStorage.getItem('appState');
      if (savedState) {
        try {
          const state = JSON.parse(savedState);
          currentState = state.currentState || 1;
          countdownStart = state.countdownStart;
          inviteStart = state.inviteStart;
          walletBalance = state.walletBalance || 0;
          transactions = state.transactions || [];
          userLevel = state.userLevel || 0;
          completedNewbieTasks = state.completedNewbieTasks || 0;
          quizCompleted = state.quizCompleted || false;
          godTasksUnlocked = state.godTasksUnlocked || false;
          teamMembers = state.teamMembers || 0;
          totalEarnings = state.totalEarnings || 0;
          withdrawFeeRate = state.withdrawFeeRate || 0.05;
          
          // 同步团队收益：总收益 = 团队人数 * 10
          const teamData = JSON.parse(localStorage.getItem('teamData') || '{}');
          if (teamData.totalMembers) {
            totalEarnings = teamData.totalMembers * 10;
            teamMembers = teamData.totalMembers;
          }
          
          // 恢复任务状态
          if (state.newTasks) {
            state.newTasks.forEach((task, index) => {
              if (newTasks[index]) newTasks[index].done = task.done;
            });
          }
          if (state.quizTasks) {
            state.quizTasks.forEach((task, index) => {
              if (quizTasks[index]) quizTasks[index].done = task.done;
            });
          }
          if (state.godTasks) {
            state.godTasks.forEach((task, index) => {
              if (godTasks[index]) godTasks[index].done = task.done;
            });
          }
        } catch (e) {
          console.warn('无法解析 appState', e);
        }
      }
    }

    /**
     * 将当前状态保存到 localStorage。
     */
    function saveState() {
      // 同步团队收益：总收益 = 团队人数 * 10
      const teamData = JSON.parse(localStorage.getItem('teamData') || '{}');
      if (teamData.totalMembers) {
        totalEarnings = teamData.totalMembers * 10;
      }
      
      const state = {
        currentState,
        countdownStart,
        inviteStart,
        walletBalance,
        transactions,
        userLevel,
        completedNewbieTasks,
        quizCompleted,
        godTasksUnlocked,
        teamMembers,
        totalEarnings,
        withdrawFeeRate,
        newTasks: newTasks.map(t => ({ ...t })),
        quizTasks: quizTasks.map(t => ({ ...t })),
        godTasks: godTasks.map(t => ({ ...t }))
      };
      localStorage.setItem('appState', JSON.stringify(state));
    }

    // 生成用户专属邀请码
    function generateUserInviteCode() {
      const userEmail = localStorage.getItem('userEmail');
      if (userEmail) {
        // 使用邮箱前缀 + 随机6位字符生成邀请码
        const emailPrefix = userEmail.split('@')[0].substring(0, 6).toUpperCase();
        const randomSuffix = Math.random().toString(36).substring(2, 8).toUpperCase();
        return emailPrefix + randomSuffix;
      }
      // 如果没有邮箱，生成随机邀请码
      return 'USER' + Math.random().toString(36).substring(2, 8).toUpperCase();
    }

    function init() {
      // 检查用户是否已登录
      const userEmail = localStorage.getItem('userEmail');
      if (!userEmail) {
        // 未登录，跳转到登录页面
        window.location.href = 'login.html';
        return;
      }
      
      // 从 localStorage 加载历史状态
      loadState();
      
      // 生成或获取用户邀请码
      let userInviteCode = localStorage.getItem('userInviteCode');
      if (!userInviteCode) {
        userInviteCode = generateUserInviteCode();
        localStorage.setItem('userInviteCode', userInviteCode);
      }
      
      renderState();
      
      // 初始化设置面板事件监听器
      initSettingsEvents();
    }

    function renderState() {
      const state = STATES[currentState];
      document.getElementById('stateLabel').innerText = state.name;
      document.getElementById('subtitle').innerText = state.subtitle;
      // 渲染卡片内容
      document.getElementById('card').innerHTML = state.card();
      
      // 更新战绩卡数据
      updateStatsDisplay();
      
      // 渲染底部按钮
      const bottom = document.getElementById('bottomButtons');
      bottom.innerHTML = '';
      
      // 严格按状态控制按钮显示
      const buttonsToShow = getButtonsForState(currentState);
      
      // 如果按钮超过6个，添加many-buttons类
      if (buttonsToShow.length > 6) {
        bottom.classList.add('many-buttons');
      } else {
        bottom.classList.remove('many-buttons');
      }
      
      buttonsToShow.forEach(btnConfig => {
        const b = document.createElement('button');
        b.innerText = btnConfig.text;
        b.classList.add(btnConfig.color);
        b.onclick = btnConfig.action;
        // 设置 data-key 以便样式定制（如邀请按钮高亮）
        if (btnConfig.key) {
          b.dataset.key = btnConfig.key;
        }
        bottom.appendChild(b);
      });
      
      // 控制倒计时
      if (currentState === 2 || currentState === 4) {
        if (!countdownStart) {
          countdownStart = Date.now();
          inviteStart = countdownStart;
        }
        updateCountdown();
        countdownTimer = setInterval(updateCountdown, 1000);
      } else {
        if (countdownTimer) clearInterval(countdownTimer);
      }
    }
    
    // 根据状态严格控制按钮显示
    function getButtonsForState(state) {
      const baseButtons = STATES[state].buttons;
      const result = [...baseButtons];
      

      
      return result;
    }
    
    // 更新战绩卡显示
    function updateStatsDisplay() {
      const taskProgressEl = document.getElementById('taskProgress');
      const teamCountEl = document.getElementById('teamCount');
      const totalEarningsEl = document.getElementById('totalEarnings');
      
      if (taskProgressEl) taskProgressEl.innerText = completedNewbieTasks;
      if (teamCountEl) teamCountEl.innerText = teamMembers;
      if (totalEarningsEl) totalEarningsEl.innerText = totalEarnings.toFixed(2);
    }

    function updateCountdown() {
      // 倒计时 168h = 7*24*3600s
      const total = 168 * 3600 * 1000;
      const now = Date.now();
      const elapsed = now - countdownStart;
      let remaining = total - elapsed;
      if (remaining < 0) remaining = 0;
      const hrs = Math.floor(remaining / 3600000);
      const mins = Math.floor((remaining % 3600000) / 60000);
      const secs = Math.floor((remaining % 60000) / 1000);
      const str = `${String(hrs).padStart(2, '0')}:${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
      const countdownEl = document.getElementById('countdown');
      if (countdownEl) countdownEl.innerText = str;
      
      // 更新邀请链接显示
      updateInviteDisplay();
      
      // 当倒计时结束，自动进入状态3
      if (remaining === 0 && currentState === 2) {
        currentState = 3;
        countdownStart = null;
        renderState();
      }
      // 当倒计时结束，在状态4回到3
      if (remaining === 0 && currentState === 4) {
        currentState = 3;
        countdownStart = null;
        renderState();
      }
    }
    
    // 更新邀请链接显示
    function updateInviteDisplay() {
      const total = 168 * 3600 * 1000;
      const now = Date.now();
      
      // 更新剩余时间显示
      const inviteEl = document.getElementById('inviteLeft');
      const progressEl = document.getElementById('inviteProgress');
      
      if (inviteEl) {
        const inviteRemainingMs = Math.max(0, (inviteStart + total) - now);
        const inviteRemainingHrs = inviteRemainingMs / 3600000;
        inviteEl.innerText = inviteRemainingHrs.toFixed(1) + 'h';
        
        // 更新进度条
        if (progressEl) {
          const progressPercent = Math.max(0, (inviteRemainingMs / total) * 100);
          progressEl.style.width = progressPercent + '%';
          
          // 根据剩余时间改变进度条颜色
          if (progressPercent > 50) {
            progressEl.style.background = 'linear-gradient(90deg, #4CAF50, #45a049, #FFD700)';
          } else if (progressPercent > 20) {
            progressEl.style.background = 'linear-gradient(90deg, #FF9800, #F57C00, #FFD700)';
          } else {
            progressEl.style.background = 'linear-gradient(90deg, #F44336, #D32F2F, #FF5722)';
          }
        }
      }
      
      // 更新邀请码和邀请链接内容
      const userInviteCode = localStorage.getItem('userInviteCode') || 'ABC123';
      
      // 更新专属邀请码显示
      const inviteCodeEl = document.getElementById('myInviteCode');
      if (inviteCodeEl) {
        inviteCodeEl.textContent = userInviteCode;
      }
      
      // 更新邀请链接
      const inviteLinkEl = document.getElementById('inviteLink');
      if (inviteLinkEl) {
        inviteLinkEl.value = `https://gold7.com/login.html?invite=${userInviteCode}`;
      }
    }

    // 开发测试循环状态
    function cycleState() {
      currentState++;
      if (currentState > 4) currentState = 1;
      countdownStart = null;
      renderState();
    }

    // 激活账号/首次入金
    function activateAccount() {
      showDialog('激活账号', '请向系统提供的USDT地址支付100 USDT以激活账号。激活后将开启168小时挑战期。');
      // 模拟支付成功
      setTimeout(() => {
        // 首次激活记录交易（入金不影响余额，余额来源于佣金）
        transactions.push({ 
          type: '激活缴费', 
          amount: -100, 
          fee: 0, 
          net: -100, 
          time: new Date().toISOString(),
          desc: '首次激活账号缴费' 
        });
        
        // 更新状态
        userLevel = 1;
        currentState = 2;
        countdownStart = Date.now();
        inviteStart = countdownStart;
        
        saveState();
        renderState();
        
        showDialog('激活成功', '账号激活成功！168小时挑战期已开始，请完成任务获得收益。');
      }, 1000);
    }

    // 再次入金（复购）
    function repurchase() {
      showDialog('再次激活', '请向系统提供的新USDT地址支付100 USDT以重新激活。重新激活后将开启新的168小时挑战期。');
      setTimeout(() => {
        // 复购记录交易
        transactions.push({ 
          type: '复购缴费', 
          amount: -100, 
          fee: 0, 
          net: -100, 
          time: new Date().toISOString(),
          desc: '复购激活缴费' 
        });
        
        // 更新状态
        currentState = 4;
        countdownStart = Date.now();
        inviteStart = countdownStart;
        
        // 解锁大神任务（需要完成新手任务+答题任务）
        if (completedNewbieTasks >= 3 && quizCompleted) {
          godTasksUnlocked = true;
        }
        
        saveState();
        renderState();
        
        showDialog('复购成功', '复购激活成功！新的168小时挑战期已开始，大神任务已解锁。');
      }, 1000);
    }

    // 任务按钮 - 实现按序触发逻辑
    function openTasks() {
      // 找到下一个未完成的任务（按ID顺序）
      const nextTask = newTasks.find(t => !t.done && t.id === completedNewbieTasks + 1);
      
      if (nextTask) {
        // 显示任务详情
        showDialog('当前任务', `任务${nextTask.id}：${nextTask.title}\n\n${nextTask.desc}\n\n完成奖励：${nextTask.reward} USDT\n\n点击确定标记完成`);
        
        // 模拟任务完成
        setTimeout(() => {
          nextTask.done = true;
          completedNewbieTasks++;
          
          // 任务奖励
          walletBalance += nextTask.reward;
          totalEarnings += nextTask.reward;
          
          // 记录交易
          transactions.push({ 
            type: '任务奖励', 
            amount: nextTask.reward, 
            fee: 0, 
            net: nextTask.reward, 
            time: new Date().toISOString(),
            desc: `完成${nextTask.title}` 
          });
          
          // 检查是否解锁答题任务
          if (completedNewbieTasks >= 1 && !quizCompleted) {
            setTimeout(() => {
              showDialog('解锁答题任务', '恭喜！解锁答题任务，完成可降低提现手续费！\n\n当前手续费：' + ((withdrawFeeRate * 100).toFixed(1)) + '%');
            }, 500);
          }
          
          saveState();
          renderState();
          
          showDialog('任务完成', `恭喜完成任务：${nextTask.title}！\n奖励：${nextTask.reward} USDT\n当前余额：${walletBalance.toFixed(2)} USDT`);
        }, 1500);
      } else if (completedNewbieTasks >= 3) {
        // 检查答题任务状态
        const quizCorrect = parseInt(localStorage.getItem('quizCorrect')) || 0;
        if (quizCorrect < 20) {
          showDialog('答题任务', '所有新手任务已完成！\n\n答题任务可用，完成20题可降低提现手续费。\n\n当前手续费：' + ((withdrawFeeRate * 100).toFixed(1)) + '%');
        } else {
          showDialog('新手任务', '所有新手任务已完成！\n\n答题任务也已完成，手续费已降至最低。');
        }
      } else {
        showDialog('任务系统', '请按顺序完成任务。');
      }
    }
    

    
    // 复制邀请链接
    function copyInvite() {
      const link = 'https://example.com/invite?code=ABC123';
      navigator.clipboard.writeText(link).then(() => {
        showDialog('邀请链接已复制', `有效期剩余 ${document.getElementById('inviteLeft').innerText}。`);
      });
    }
    
    // 新的复制邀请链接函数
    function copyInviteLink() {
      const linkInput = document.getElementById('inviteLink');
      const link = linkInput.value;
      
      if (navigator.clipboard) {
        navigator.clipboard.writeText(link).then(() => {
          const detailedTime = getDetailedCountdown();
          showDialog('邀请链接已复制', `有效期剩余 ${detailedTime}`);
        }).catch(() => {
          fallbackCopy(link);
        });
      } else {
        fallbackCopy(link);
      }
    }
    
    // 复制专属邀请码函数
    function copyInviteCode() {
      const codeEl = document.getElementById('myInviteCode');
      const code = codeEl.textContent;
      
      if (navigator.clipboard) {
        navigator.clipboard.writeText(code).then(() => {
          const detailedTime = getDetailedCountdown();
          showDialog('邀请码已复制', `专属邀请码: ${code}\n有效期剩余 ${detailedTime}`);
        }).catch(() => {
          fallbackCopyCode(code);
        });
      } else {
        fallbackCopyCode(code);
      }
    }
    
    // 获取详细倒计时时间
    function getDetailedCountdown() {
      const total = 168 * 3600 * 1000;
      const now = Date.now();
      const inviteRemainingMs = Math.max(0, (inviteStart + total) - now);
      const hrs = Math.floor(inviteRemainingMs / 3600000);
      const mins = Math.floor((inviteRemainingMs % 3600000) / 60000);
      const secs = Math.floor((inviteRemainingMs % 60000) / 1000);
      return `${String(hrs).padStart(2, '0')}:${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
    }
    
    // 降级复制方案
    function fallbackCopy(text) {
      const textArea = document.createElement('textarea');
      textArea.value = text;
      document.body.appendChild(textArea);
      textArea.select();
      try {
        document.execCommand('copy');
        const detailedTime = getDetailedCountdown();
        showDialog('邀请链接已复制', `有效期剩余 ${detailedTime}`);
      } catch (err) {
        showDialog('复制失败', '请手动复制链接');
      }
      document.body.removeChild(textArea);
    }
    
    // 降级复制邀请码方案
    function fallbackCopyCode(code) {
      const textArea = document.createElement('textarea');
      textArea.value = code;
      document.body.appendChild(textArea);
      textArea.select();
      try {
        document.execCommand('copy');
        const detailedTime = getDetailedCountdown();
        showDialog('邀请码已复制', `专属邀请码: ${code}\n有效期剩余 ${detailedTime}`);
      } catch (err) {
        showDialog('复制失败', '请手动复制邀请码');
      }
      document.body.removeChild(textArea);
    }
    // 抢红包 - 严格时间窗口和资格校验
    function grabRedPacket() {
      // 检查资格：仅状态2或4
      if (currentState !== 2 && currentState !== 4) {
        showDialog('无抢红包资格', '只有在激活状态（初次挑战或复购状态）才可以抢红包。');
        return;
      }
      
      // 严格时间检查：每日9:00/12:00/20:00 开始，持续77秒
      const now = new Date();
      const hours = now.getHours();
      const minutes = now.getMinutes();
      const seconds = now.getSeconds();
      
      const isValidHour = hours === 9 || hours === 12 || hours === 20;
      const isValidTime = isValidHour && minutes === 0 && seconds < 77;
      
      if (!isValidTime) {
        // 计算下一场红包时间
        let nextHour;
        if (hours < 9) nextHour = 9;
        else if (hours < 12) nextHour = 12;
        else if (hours < 20) nextHour = 20;
        else nextHour = 9; // 明天9点
        
        const nextDay = hours >= 20 ? '明日' : '今日';
        showDialog('红包未开始', `红包活动每日9:00、12:00、20:00开始，每次仅开放77秒。\n\n下一场：${nextDay} ${nextHour}:00`);
        return;
      }
      
      // 检查是否已经抢过（每场限抢一次）
      const todayKey = now.toDateString();
      const sessionKey = `${todayKey}_${hours}`;
      const grabbedSessions = JSON.parse(localStorage.getItem('grabbedSessions') || '[]');
      
      if (grabbedSessions.includes(sessionKey)) {
        showDialog('已抢过红包', '本场红包已抢过，请等待下一场。');
        return;
      }
      
      // 抢红包成功
      const prize = parseFloat((Math.random() * 4.99 + 0.01).toFixed(2));
      walletBalance += prize;
      totalEarnings += prize;
      
      // 记录本场已抢
      grabbedSessions.push(sessionKey);
      localStorage.setItem('grabbedSessions', JSON.stringify(grabbedSessions));
      
      // 记录交易
      transactions.push({ 
        type: '红包收入', 
        amount: prize, 
        fee: 0, 
        net: prize, 
        time: new Date().toISOString(),
        desc: `${hours}:00场红包` 
      });
      
      saveState();
      renderState();
      
      showDialog('抢红包成功', `🎉 恭喜抢到红包：${prize.toFixed(2)} USDT！\n\n当前余额：${walletBalance.toFixed(2)} USDT\n剩余时间：${77 - seconds}秒`);
    }
    // 我的团队
    function showTeam() {
      // 跳转到团队页面
      window.location.href = 'team.html';
    }
    // 我的钱包
    function showWallet() {
      // 跳转到钱包页面
      window.location.href = 'wallet.html';
    }
    // 排行榜
    function showRanking() {
      // 跳转到排行榜页面
      window.location.href = 'ranking.html';
    }
    function showRedRanking() {
      showDialog('红包排行榜', '按红包收入USDT总额排行。');
    }
    function showGodRanking() {
      showDialog('大神排行榜', '按大神等级排行。');
    }
    function openGodTasks() {
      showDialog('大神任务', '请在卡片中查看大神任务目标。');
    }
    /* 对话框 */
    function showDialog(title, msg) {
      document.getElementById('dialogTitle').innerText = title;
      document.getElementById('dialogMsg').innerText = msg;
      document.getElementById('dialog').style.display = 'flex';
    }
    function closeDialog() {
      document.getElementById('dialog').style.display = 'none';
    }

    /**
     * 重置测试数据
     */
    function resetTestData() {
      if(confirm('确定要重置所有测试数据吗？此操作不可撤销。')) {
        // 重置所有任务状态
        newTasks.forEach(task => task.done = false);
        quizCompleted = false;
        godTasksCompleted = false;
        
        // 生成随机团队人数 (1-50人)
        const randomTeamSize = Math.floor(Math.random() * 50) + 1;
        
        // 设置余额为团队人数*10 USDT
        const newBalance = randomTeamSize * 10;
        
        // 清空localStorage中的相关数据
        localStorage.removeItem('userTasks');
        localStorage.removeItem('quizCompleted');
        localStorage.removeItem('godTasksCompleted');
        localStorage.removeItem('userBalance');
        localStorage.removeItem('teamSize');
        
        // 重置答题相关数据
        localStorage.removeItem('quizIndex');
        localStorage.removeItem('quizCorrect');
        localStorage.setItem('withdrawFeeRate', '0.05'); // 重置手续费为5%
        
        // 清除交易记录和应用状态数据
        localStorage.removeItem('transactions');
        localStorage.removeItem('appState');
        localStorage.removeItem('teamData');
        localStorage.removeItem('recentRed');
        
        // 重置全局变量到初始状态
        transactions = [];
        userLevel = 0;
        completedNewbieTasks = 0;
        godTasksUnlocked = false;
        teamMembers = randomTeamSize;
        totalEarnings = randomTeamSize * 10;
        withdrawFeeRate = 0.05;
        walletBalance = randomTeamSize * 10;
        countdownStart = null;
        inviteStart = null;
        
        // 设置新的数据到localStorage
        localStorage.setItem('teamSize', randomTeamSize.toString());
        localStorage.setItem('userBalance', newBalance.toString());
        
        // 重置到状态1
        currentState = 1;
        
        // 重新渲染页面
        renderState();
        
        // 强制显示风格选择弹窗
        showForceThemeSelection(randomTeamSize, newBalance);
      }
    }

    /**
     * 强制风格选择弹窗
     */
    function showForceThemeSelection(teamSize, balance) {
      const themes = {
        'cyberpunk': { name: '赛博朋克', icon: '🌆', description: '未来科技感' },
        'rainbow': { name: '彩虹渐变', icon: '🌈', description: '多彩绚烂' },
        'business': { name: '商务蓝', icon: '💼', description: '专业稳重' },
        'dark-tech': { name: '暗黑科技', icon: '⚡', description: '神秘酷炫' },
        'fresh': { name: '清新绿', icon: '🌿', description: '自然清新' }
      };
      
      const themeOptionsHTML = Object.entries(themes).map(([key, theme]) => `
        <div class="force-theme-option" data-theme="${key}">
          <span class="force-theme-icon">${theme.icon}</span>
          <div class="force-theme-info">
            <div class="force-theme-name">${theme.name}</div>
            <div class="force-theme-desc">${theme.description}</div>
          </div>
        </div>
      `).join('');
      
      const modalHTML = `
        <div id="forceThemeModal" class="force-theme-modal">
          <div class="force-theme-content">
            <div class="force-theme-header">
              <h2>🎨 选择您的专属风格</h2>
              <p>数据重置成功！请选择一个风格主题继续使用</p>
            </div>
            <div class="force-theme-options">
              ${themeOptionsHTML}
            </div>
            <div class="force-theme-footer">
              <p class="force-theme-info-text">团队人数：${teamSize}人 | 余额：${balance} USDT | 所有任务已重置</p>
            </div>
          </div>
        </div>
      `;
      
      // 添加样式
      const styleHTML = `
        <style>
        .force-theme-modal {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.8);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 10000;
          backdrop-filter: blur(10px);
        }
        .force-theme-content {
          background: var(--bg-card);
          border-radius: 20px;
          padding: 24px;
          max-width: 400px;
          width: 90%;
          box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
          border: 1px solid var(--border-color);
        }
        .force-theme-header {
          text-align: center;
          margin-bottom: 20px;
        }
        .force-theme-header h2 {
          color: var(--text-primary);
          margin: 0 0 8px 0;
          font-size: 20px;
        }
        .force-theme-header p {
          color: var(--text-secondary);
          margin: 0;
          font-size: 14px;
        }
        .force-theme-options {
          display: flex;
          flex-direction: column;
          gap: 8px;
          margin-bottom: 20px;
        }
        .force-theme-option {
          display: flex;
          align-items: center;
          gap: 12px;
          padding: 12px;
          border: 2px solid var(--border-color);
          border-radius: 12px;
          cursor: pointer;
          transition: all 0.3s ease;
          background: var(--bg-secondary);
        }
        .force-theme-option:hover {
          border-color: var(--accent-color);
          transform: translateY(-2px);
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        .force-theme-option.selected {
          border-color: var(--accent-color);
          background: var(--btn-gradient);
          color: var(--text-primary);
        }
        .force-theme-icon {
          font-size: 24px;
          width: 32px;
          text-align: center;
        }
        .force-theme-info {
          flex: 1;
        }
        .force-theme-name {
          font-weight: 600;
          font-size: 16px;
          margin-bottom: 2px;
        }
        .force-theme-desc {
          font-size: 12px;
          opacity: 0.8;
        }
        .force-theme-footer {
          text-align: center;
        }
        .force-theme-info-text {
          font-size: 12px;
          color: var(--text-secondary);
          margin: 0;
        }
        </style>
      `;
      
      // 插入样式和模态框
      document.head.insertAdjacentHTML('beforeend', styleHTML);
      document.body.insertAdjacentHTML('beforeend', modalHTML);
      
      // 绑定事件
      const modal = document.getElementById('forceThemeModal');
      const options = document.querySelectorAll('.force-theme-option');
      
      options.forEach(option => {
        option.addEventListener('click', () => {
          const selectedTheme = option.getAttribute('data-theme');
          
          // 应用选中的主题
          if (window.themeSwitcher) {
            window.themeSwitcher.switchTheme(selectedTheme);
          } else {
            document.documentElement.setAttribute('data-theme', selectedTheme === 'cyberpunk' ? '' : selectedTheme);
            localStorage.setItem('selectedTheme', selectedTheme);
          }
          
          // 关闭模态框
          modal.remove();
          
          // 显示成功信息
          const themeName = themes[selectedTheme].name;
          showDialog('风格设置成功', `已切换至${themeName}风格\n团队人数：${teamSize}人\n余额：${balance} USDT\n所有任务已重置`);
        });
      });
    }

    /**
     * 模态弹窗管理
     */
    const modal = document.getElementById('modal');
    const modalClose = document.getElementById('modalClose');
    const modalBody = document.getElementById('modalBody');
    modalClose.addEventListener('click', () => {
      modal.style.display = 'none';
    });
    function openModal(type) {
      let html = '';
      if(type === 'task') {
        const currentTask = newTasks.find(t => !t.done);
        if(currentTask) {
          html += `<h3 style="margin-top:0;color:var(--brand)">${currentTask.title}</h3>`;
          html += `<p style="font-size:14px;color:var(--muted)">${currentTask.desc ? currentTask.desc : '完成此任务可推进进度。'}</p>`;
          html += `<button class="btn" id="modalTaskDone" style="margin-top:16px;width:100%">标记完成</button>`;
        } else {
          html += `<h3 style="margin-top:0;color:var(--brand)">所有新手任务已完成</h3>`;
          html += `<p style="font-size:14px;color:var(--muted)">无需再执行新手任务。</p>`;
        }
      } else if(type === 'wallet') {
        html += `<h3 style="margin-top:0;color:var(--brand)">我的钱包</h3>`;
        html += `<p style="font-size:14px;color:var(--muted)">当前余额：-- USDT</p>`;
        html += `<button class="btn" style="margin-top:16px;width:100%">提现</button>`;
      } else if(type === 'team') {
        html += `<h3 style="margin-top:0;color:var(--brand)">我的团队</h3>`;
        html += `<p style="font-size:14px;color:var(--muted)">此处展示七层团队结构（占位）</p>`;
      } else if(type === 'ranking') {
        html += `<h3 style="margin-top:0;color:var(--brand)">排行榜</h3>`;
        html += `<p style="font-size:14px;color:var(--muted)">此处展示团队、红包与大神排行（占位）</p>`;
      }
      modalBody.innerHTML = html;
      modal.style.display = 'flex';
      // 绑定任务完成按钮
      const completeBtn = document.getElementById('modalTaskDone');
      if(completeBtn) {
        completeBtn.addEventListener('click', () => {
          const task = newTasks.find(t => !t.done);
          if(task) task.done = true;
          modal.style.display = 'none';
          renderState();
        });
      }
    }

    // 退出登录功能
    function logout() {
      if (confirm('确定要退出登录吗？')) {
        // 清除用户登录信息
        localStorage.removeItem('userEmail');
        localStorage.removeItem('userPassword');
        
        // 跳转到登录页面
        window.location.href = 'login.html';
      }
    }

    // 设置面板功能已移至script开头

    // 初始化设置面板事件监听器
    function initSettingsEvents() {
      // 语言切换功能
      const languageSelect = document.getElementById('languageSelect');
      if (languageSelect) {
        languageSelect.addEventListener('change', function() {
          const selectedLanguage = this.value;
          localStorage.setItem('language', selectedLanguage);
          
          // 这里可以添加实际的语言切换逻辑
          showDialog('语言设置', `已切换到：${this.options[this.selectedIndex].text}`);
        });
      }

      // 点击模态框背景关闭设置面板
      document.addEventListener('click', function(e) {
        const settingsModal = document.getElementById('settingsModal');
        if (e.target === settingsModal) {
          closeSettings();
        }
      });
    }

    window.onload = init;
  </script>
  <script src="js/global-background.js"></script>
</body>
</html>